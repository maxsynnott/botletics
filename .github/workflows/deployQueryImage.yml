name: Deploy query

on:
  workflow_dispatch:

  push:
    branches:
      - master
    paths:
      - servers/lambdas/query/**
      - servers/server/prisma/**

defaults:
  run:
    shell: bash

jobs:
  buildAndPushImage:
    uses: maxsynnott/botletics/.github/workflows/buildAndPushImage.yml@master
    with:
      ecrRepositoryName: botletics-db-query
      directoryPath: ./servers/lambdas/query
      copyPrismaDirectory: true
    secrets:
      awsAccessKeyId: ${{ secrets.AWS_ACCESS_KEY_ID }}
      awsSecretKey: ${{ secrets.AWS_SECRET_KEY }}
      dockerHubUsername: ${{ secrets.DOCKER_HUB_USERNAME }}
      dockerHubAccessToken: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

  updateLambdaImageUri:
    needs: buildAndPushImage
    uses: maxsynnott/botletics/.github/workflows/updateLambdaImageUri.yml@master
    with:
      ecrRepositoryName: botletics-db-query
      lambdaFunctionName: query
    secrets:
      awsAccessKeyId: ${{ secrets.AWS_ACCESS_KEY_ID }}
      awsSecretKey: ${{ secrets.AWS_SECRET_KEY }}
